generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  role          String    @default("user") // user, admin, executive
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  leads         Lead[]
  projects      Project[]
  assignedTasks Task[]    @relation("AssignedTasks")
  createdTasks  Task[]    @relation("CreatedTasks")
  activities    Activity[]
}

model Lead {
  id              String    @id @default(cuid())
  name            String
  company         String?
  email           String?
  phone           String?
  bio             String?
  status          String    @default("new") // new, contacted, qualified, proposal, negotiation, won, lost
  source          String?
  estimatedValue  Float?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  wonAt           DateTime?

  // Relations
  ownerId         String
  owner           User      @relation(fields: [ownerId], references: [id])
  contacts        Contact[]
  conversations   Conversation[]
  project         Project?
}

model Contact {
  id          String    @id @default(cuid())
  name        String
  email       String?
  phone       String?
  role        String?   // Decision Maker, Technical Contact, etc.
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model Conversation {
  id          String    @id @default(cuid())
  subject     String
  summary     String?
  date        DateTime
  type        String    // email, meeting, call
  outlookId   String?   // For Outlook integration
  createdAt   DateTime  @default(now())

  // Relations
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model Project {
  id              String    @id @default(cuid())
  name            String
  description     String?
  status          String    @default("active") // active, on-hold, completed, cancelled
  startDate       DateTime?
  endDate         DateTime?
  contractValue   Float
  percentComplete Float     @default(0)
  paymentType     String    @default("milestone") // milestone, percent, monthly
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  leadId          String?   @unique
  lead            Lead?     @relation(fields: [leadId], references: [id])
  managerId       String
  manager         User      @relation(fields: [managerId], references: [id])
  tasks           Task[]
  payments        Payment[]
  expenses        Expense[]
  milestones      Milestone[]
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  status      String    @default("pending") // pending, in-progress, completed
  priority    String    @default("medium") // low, medium, high, urgent
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assigneeId  String?
  assignee    User?     @relation("AssignedTasks", fields: [assigneeId], references: [id])
  createdById String
  createdBy   User      @relation("CreatedTasks", fields: [createdById], references: [id])
}

model Milestone {
  id          String    @id @default(cuid())
  name        String
  description String?
  dueDate     DateTime?
  completedAt DateTime?
  percentage  Float?    // For percent-based payments
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  payments    Payment[]
}

model Payment {
  id          String    @id @default(cuid())
  amount      Float
  dueDate     DateTime
  paidDate    DateTime?
  status      String    @default("pending") // pending, invoiced, paid, overdue
  type        String    // milestone, percent, monthly
  description String?
  invoiceNumber String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestoneId String?
  milestone   Milestone? @relation(fields: [milestoneId], references: [id])
}

model Expense {
  id          String    @id @default(cuid())
  description String
  amount      Float
  category    String    // labor, materials, travel, software, other
  date        DateTime
  vendor      String?
  receipt     String?   // URL to receipt
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Activity {
  id          String    @id @default(cuid())
  type        String    // lead_created, lead_updated, project_created, task_completed, payment_received, etc.
  description String
  metadata    String?   // JSON string for additional data
  createdAt   DateTime  @default(now())

  // Relations
  userId      String
  user        User      @relation(fields: [userId], references: [id])
}
